"""
Actions custom pour le chatbot Rasa.
Ces actions appellent l'API Spring Boot (http://localhost:8093) pour r√©cup√©rer
les donn√©es r√©elles des demandes depuis la base de donn√©es MySQL.
"""

import requests
import re
from typing import Any, Text, Dict, List
from rasa_sdk import Action, Tracker
from rasa_sdk.executor import CollectingDispatcher
from rasa_sdk.events import SlotSet

# URL de base de votre API Spring Boot
SPRING_BOOT_API = "http://localhost:8093/api"


class ActionVoirDemandes(Action):
    """
    Action pour r√©cup√©rer toutes les demandes d'un utilisateur
    depuis l'API Spring Boot.
    """

    def name(self) -> Text:
        return "action_voir_demandes"

    def run(
        self,
        dispatcher: CollectingDispatcher,
        tracker: Tracker,
        domain: Dict[Text, Any],
    ) -> List[Dict[Text, Any]]:

        # R√©cup√©rer le user_id depuis les m√©tadonn√©es du message
        user_id = tracker.get_slot("user_id")

        # Essayer aussi de r√©cup√©rer depuis les metadata
        if not user_id:
            metadata = tracker.latest_message.get("metadata", {})
            user_id = metadata.get("userId") or metadata.get("user_id")

        if not user_id:
            dispatcher.utter_message(
                text="Vous devez √™tre connect√© pour consulter vos demandes.",
                buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
            )
            return []

        try:
            # Appel √† l'API Spring Boot
            response = requests.get(
                f"{SPRING_BOOT_API}/demandes/mes-demandes/{user_id}",
                timeout=10,
            )

            if response.status_code == 200:
                demandes = response.json()

                if not demandes:
                    dispatcher.utter_message(
                        text="Vous n'avez aucune demande pour le moment.\n\nSouhaitez-vous en soumettre une ?",
                        buttons=[
                            {
                                "title": "‚ûï Soumettre une demande",
                                "payload": "/soumettre_demande",
                            },
                            {
                                "title": "üìÇ Types de demandes",
                                "payload": "/types_demandes",
                            },
                            {"title": "‚ùì Aide", "payload": "/demander_aide"},
                        ],
                    )
                    return []

                # Construire le message avec les demandes
                msg = f"**Vos demandes** ({len(demandes)}) :\n\n"

                for d in demandes:
                    ref = d.get("reference", "N/A")
                    titre = d.get("titreDemande", "Sans titre")
                    type_dem = d.get("typeDemande", "N/A")
                    status = self._format_status(d.get("status", "N/A"))
                    date = d.get("dateDepot", "")

                    msg += f"‚Ä¢ **{ref}** ‚Äî {titre}\n"
                    msg += f"   Type: {type_dem} | Statut: **{status}**"
                    if date:
                        msg += f" | Date: {date[:10]}"
                    msg += "\n\n"

                msg += "üí° Tapez une r√©f√©rence (ex: REF-12345) pour plus de d√©tails."

                dispatcher.utter_message(
                    text=msg,
                    buttons=[
                        {
                            "title": "‚ûï Soumettre une demande",
                            "payload": "/soumettre_demande",
                        },
                        {
                            "title": "‚è± D√©lais de traitement",
                            "payload": "/delais_traitement",
                        },
                        {"title": "‚ùì Aide", "payload": "/demander_aide"},
                    ],
                )
            else:
                dispatcher.utter_message(
                    text="D√©sol√©, je n'ai pas pu r√©cup√©rer vos demandes. Veuillez r√©essayer plus tard.",
                    buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
                )

        except requests.exceptions.ConnectionError:
            dispatcher.utter_message(
                text="‚ö†Ô∏è Le serveur est temporairement indisponible. Veuillez r√©essayer dans quelques instants.",
                buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
            )
        except Exception as e:
            dispatcher.utter_message(
                text=f"Une erreur est survenue : {str(e)}",
                buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
            )

        return []

    def _format_status(self, status: str) -> str:
        status_map = {
            "SOUMISE": "Soumise",
            "EN_TRAITEMENT": "En traitement",
            "VALIDEE": "Valid√©e",
            "REJETEE": "Rejet√©e",
        }
        return status_map.get(status, status)


class ActionChercherReference(Action):
    """
    Action pour chercher une demande par sa r√©f√©rence
    depuis l'API Spring Boot.
    """

    def name(self) -> Text:
        return "action_chercher_reference"

    def run(
        self,
        dispatcher: CollectingDispatcher,
        tracker: Tracker,
        domain: Dict[Text, Any],
    ) -> List[Dict[Text, Any]]:

        # Extraire la r√©f√©rence du message
        message = tracker.latest_message.get("text", "")
        reference = tracker.get_slot("reference")

        # Si pas de slot, essayer d'extraire depuis le message
        if not reference:
            ref_match = re.search(r"REF[- ]?(\d+)", message, re.IGNORECASE)
            if ref_match:
                reference = f"REF-{ref_match.group(1)}"

        if not reference:
            dispatcher.utter_message(
                text="Veuillez fournir une r√©f√©rence valide (ex: REF-12345).",
                buttons=[
                    {
                        "title": "üìã Voir mes demandes",
                        "payload": "/voir_demandes",
                    },
                    {"title": "‚ùì Aide", "payload": "/demander_aide"},
                ],
            )
            return []

        # S'assurer que la r√©f√©rence est au bon format
        if not reference.upper().startswith("REF-"):
            reference = f"REF-{reference}"

        user_id = tracker.get_slot("user_id")
        if not user_id:
            metadata = tracker.latest_message.get("metadata", {})
            user_id = metadata.get("userId") or metadata.get("user_id")

        try:
            # Appel √† l'API Spring Boot pour chercher par r√©f√©rence
            response = requests.get(
                f"{SPRING_BOOT_API}/demandes/reference/{reference}",
                timeout=10,
            )

            if response.status_code == 200:
                d = response.json()

                msg = f"**D√©tails de la demande {d.get('reference', reference)}** :\n\n"
                msg += f"‚Ä¢ **Titre** : {d.get('titreDemande', 'N/A')}\n"
                msg += f"‚Ä¢ **Type** : {d.get('typeDemande', 'N/A')}\n"
                msg += f"‚Ä¢ **Statut** : **{self._format_status(d.get('status', 'N/A'))}**\n"

                date = d.get("dateDepot", "")
                if date:
                    msg += f"‚Ä¢ **Date de d√©p√¥t** : {date[:10]}\n"

                desc = d.get("description", "")
                if desc:
                    msg += f"‚Ä¢ **Description** : {desc}\n"

                dispatcher.utter_message(
                    text=msg,
                    buttons=[
                        {
                            "title": "üìã Voir mes demandes",
                            "payload": "/voir_demandes",
                        },
                        {
                            "title": "‚ûï Soumettre une demande",
                            "payload": "/soumettre_demande",
                        },
                        {"title": "‚ùì Aide", "payload": "/demander_aide"},
                    ],
                )
            elif response.status_code == 404:
                dispatcher.utter_message(
                    text=f"Aucune demande trouv√©e avec la r√©f√©rence **{reference}**.\n\nV√©rifiez la r√©f√©rence et r√©essayez. Le format est : REF-XXXXX",
                    buttons=[
                        {
                            "title": "üìã Voir mes demandes",
                            "payload": "/voir_demandes",
                        },
                        {"title": "‚ùì Aide", "payload": "/demander_aide"},
                    ],
                )
            else:
                dispatcher.utter_message(
                    text="D√©sol√©, une erreur est survenue lors de la recherche.",
                    buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
                )

        except requests.exceptions.ConnectionError:
            dispatcher.utter_message(
                text="‚ö†Ô∏è Le serveur est temporairement indisponible. Veuillez r√©essayer.",
                buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
            )
        except Exception as e:
            dispatcher.utter_message(
                text=f"Une erreur est survenue : {str(e)}",
                buttons=[{"title": "‚ùì Aide", "payload": "/demander_aide"}],
            )

        return [SlotSet("reference", reference)]

    def _format_status(self, status: str) -> str:
        status_map = {
            "SOUMISE": "Soumise",
            "EN_TRAITEMENT": "En traitement",
            "VALIDEE": "Valid√©e",
            "REJETEE": "Rejet√©e",
        }
        return status_map.get(status, status)
